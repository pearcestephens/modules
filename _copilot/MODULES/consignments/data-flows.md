# Consignments Module - Data Flows

## Overview
Database interactions, API data flows, and external integrations for the Consignments module.

**Last Updated:** 2025-10-12 07:00 UTC

## Database Schema

### Core Tables
| Table | Purpose | Key Fields |
|-------|---------|------------|
| `transfers` | Transfer records | `id`, `from_outlet_id`, `to_outlet_id`, `status`, `created_at` |
| `transfer_lines` | Transfer line items | `transfer_id`, `product_id`, `qty_requested`, `qty_packed`, `qty_received` |
| `outlets` | Store/outlet information | `id`, `name`, `code`, `active` |
| `products` | Product catalog | `id`, `sku`, `name`, `barcode`, `cost_price` |
| `inventory` | Stock levels | `outlet_id`, `product_id`, `qty_available`, `qty_allocated` |

### Audit Tables
| Table | Purpose | Key Fields |
|-------|---------|------------|
| `transfer_audit` | Transfer state changes | `transfer_id`, `action`, `user_id`, `timestamp`, `details` |
| `inventory_movements` | Stock movement tracking | `outlet_id`, `product_id`, `movement_type`, `qty`, `reference_id` |

## Data Flow Patterns

### Pack Operation Flow
```
1. Load Transfer Data
   transfers → transfer_lines → products → inventory

2. Product Search & Add
   products.search() → inventory.check() → transfer_lines.add()

3. Quantity Updates  
   transfer_lines.update() → inventory.allocate()

4. Pack Submission
   transfer_lines.pack() → inventory.deduct() → transfers.mark_packed()
   → transfer_audit.log() → inventory_movements.record()
```

### Receive Operation Flow
```
1. Load Packed Transfer
   transfers → transfer_lines (where qty_packed > 0) → products

2. Receive Validation
   qty_received <= qty_packed → discrepancy.check()

3. Receive Submission  
   transfer_lines.receive() → inventory.add() → transfers.mark_received()
   → transfer_audit.log() → inventory_movements.record()
```

## API Endpoints & Data Exchange

### AJAX API Responses
```json
{
  "success": true|false,
  "data": {...},
  "message": "Human readable message",
  "errors": [...],
  "csrf_token": "new_token_if_needed"
}
```

### Pack API Data Flows

#### Add Line Endpoint
**Request:** `POST /api/add_line.php`
```json
{
  "transfer_id": 123,
  "product_id": 456,
  "quantity": 10,
  "csrf_token": "..."
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "line_id": 789,
    "product": {...},
    "qty_available": 25
  },
  "message": "Product added successfully"
}
```

#### Update Quantity Endpoint
**Request:** `POST /api/update_line_qty.php`
```json
{
  "line_id": 789,
  "quantity": 8,
  "csrf_token": "..."
}
```

### Receive API Data Flows

#### Submit Receive Endpoint
**Request:** `POST /api/receive_submit.php`
```json
{
  "transfer_id": 123,
  "lines": [
    {"line_id": 789, "qty_received": 8, "notes": "2 damaged"},
    {"line_id": 790, "qty_received": 15}
  ],
  "csrf_token": "..."
}
```

## External Integrations

### Vend API Integration
```php
// Sync inventory levels
VendAPI::updateInventory($outlet_id, $product_id, $new_quantity);

// Create consignment in Vend
VendAPI::createConsignment($transfer_data);
```

### CIS Core Integration
```php
// User permissions
CIS::checkPermission('consignments.pack');

// Outlet access
CIS::getUserOutlets($user_id);

// Audit logging
CIS::auditLog('transfer.packed', $transfer_id, $details);
```

## Caching Strategy

### Query Caching
- **Product Search:** 5-minute cache for search results
- **Outlet List:** 1-hour cache for outlet dropdown
- **User Permissions:** Session-based cache

### Cache Keys
```
products:search:{query_hash}
outlets:active
user:{user_id}:permissions
transfer:{id}:lock_status
```

## Database Query Patterns

### Optimized Queries
```sql
-- Transfer with lines (single query)
SELECT t.*, tl.*, p.sku, p.name, p.barcode
FROM transfers t
LEFT JOIN transfer_lines tl ON t.id = tl.transfer_id  
LEFT JOIN products p ON tl.product_id = p.id
WHERE t.id = ?

-- Available inventory check
SELECT SUM(qty_available - qty_allocated) as available
FROM inventory 
WHERE outlet_id = ? AND product_id = ?

-- Product search with inventory
SELECT p.*, i.qty_available
FROM products p
LEFT JOIN inventory i ON p.id = i.product_id AND i.outlet_id = ?
WHERE p.name LIKE ? OR p.sku LIKE ? OR p.barcode = ?
LIMIT 20
```

## Data Validation Rules

### Pack Validation
- Quantity must be ≤ available inventory
- Transfer must be in 'draft' status
- User must have access to source outlet
- Product must be active

### Receive Validation  
- Quantity must be ≤ packed quantity
- Transfer must be in 'packed' status
- User must have access to destination outlet
- Cannot receive more than packed

## Error Handling & Recovery

### Database Errors
- Transaction rollback on failure
- Detailed error logging
- User-friendly error messages
- Automatic retry for deadlocks

### Data Consistency
- Foreign key constraints enforced
- Inventory levels validated before updates
- Audit trail for all changes
- Periodic reconciliation reports

---
*Generated by CIS Knowledge Base System*
