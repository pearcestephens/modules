<?php
namespace CIS\Base; use Services\Database; class UnifiedThemeContext { private static ?array $cached=null; public static function getActive(): array { if(self::$cached){ return self::$cached; } $db=Database::getInstance(); $userId=$_SESSION['user_id']??1; try { $stmt=$db->execute('SELECT id,name,theme_data,is_active FROM user_themes WHERE user_id=? AND is_active=1 LIMIT 1',[$userId]); $row=$stmt->fetch(); if($row){ $data=json_decode($row['theme_data'],true)?:[]; self::$cached=['id'=>(int)$row['id'],'name'=>$row['name'],'tokens'=>$data,'source'=>'db']; return self::$cached; } } catch(\Exception $e){} $pack=ThemeManager::getActive(); self::$cached=['id'=>null,'name'=>$pack,'tokens'=>[],'source'=>'session']; return self::$cached; } }
