RewriteEngine On

# Base for this module subtree
RewriteBase /modules/consignments/

# Disable directory indexing
Options -Indexes

# HTTPS enforcement (safe behind reverse proxy)
# Cloudways terminates TLS at Nginx; Apache may see HTTPS=off even for HTTPS requests.
# Respect X-Forwarded-Proto to avoid self-redirect loops.
RewriteCond %{HTTPS} !=on
RewriteCond %{HTTP:X-Forwarded-Proto} !https [NC]
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Allow direct access to API endpoints when bot=true (for testing)
RewriteCond %{QUERY_STRING} (^|&)bot=true(&|$)
RewriteRule ^api/.*\.php$ - [L]

# Block direct access to private/internal PHP libs and views
RewriteRule ^_shared/ - [R=404,L]
RewriteRule ^transfers/(lib|controllers|views)/.*\.php$ - [R=404,L]

# Serve existing files/directories directly
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Route everything else to front controller
RewriteRule ^(.+)$ index.php [QSA,L]

# Security headers as fallback if not set upstream
<IfModule mod_headers.c>
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set X-XSS-Protection "1; mode=block"
</IfModule>

AddType text/javascript .js .mjs

# Cache static assets
<FilesMatch "\.(css|js|png|jpg|jpeg|gif|svg|webp|woff2?)$">
  FileETag MTime Size
  Header set Cache-Control "public, max-age=31536000, immutable"
</FilesMatch>

# Environment variable override (uncomment if needed)
# SetEnv APP_ENV prod
