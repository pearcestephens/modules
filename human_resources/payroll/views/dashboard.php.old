<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll Dashboard | The Vape Shed</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; padding-top: 20px; }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .stat-card .icon { font-size: 2.5rem; opacity: 0.3; }
        .stat-card h3 { font-size: 2rem; font-weight: bold; margin: 10px 0; }
        .stat-card p { margin: 0; color: #6c757d; }
        .action-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .action-card h4 { margin-top: 0; }
        .action-card button { margin-top: 10px; }
        .ai-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 5px;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-draft { background: #e9ecef; color: #495057; }
        .status-processing { background: #fff3cd; color: #856404; }
        .status-ready { background: #d4edda; color: #155724; }
        .status-posted { background: #d1ecf1; color: #0c5460; }
        #timeline { border-left: 3px solid #007bff; padding-left: 20px; margin-left: 10px; }
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            left: -27px;
            top: 5px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
        }
        .timeline-item.complete:before { background: #28a745; }
        .timeline-item.pending:before { background: #ffc107; }
    </style>
</head>
<body>

<div class="container-fluid">

    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1>
                <i class="fas fa-money-bill-wave"></i> Payroll Dashboard
                <span class="ai-badge">AI POWERED</span>
            </h1>
            <p class="text-muted">Complete payroll management with AI automation & wage discrepancy handling</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" id="btnNewPayRun">
                <i class="fas fa-plus"></i> New Pay Run
            </button>
            <button class="btn btn-outline-secondary" id="btnRefresh">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="row">
        <div class="col-md-3">
            <div class="stat-card text-center">
                <i class="fas fa-users icon text-primary"></i>
                <h3 id="statActiveStaff">-</h3>
                <p>Active Staff</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <i class="fas fa-clock icon text-warning"></i>
                <h3 id="statPendingHours">-</h3>
                <p>Pending Hours</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <i class="fas fa-exclamation-triangle icon text-danger"></i>
                <h3 id="statDiscrepancies">-</h3>
                <p>Pending Discrepancies</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center">
                <i class="fas fa-robot icon text-success"></i>
                <h3 id="statAutoApproved">-</h3>
                <p>Auto-Approved Today</p>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">

        <!-- Left Column: Current Pay Run -->
        <div class="col-md-8">

            <!-- Current Pay Run Card -->
            <div class="action-card" id="currentPayRunCard">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h4>
                            <i class="fas fa-calendar-week"></i>
                            Current Pay Run
                            <span class="status-badge status-draft" id="currentPayRunStatus">No Active Run</span>
                        </h4>
                        <p class="text-muted mb-0" id="currentPayRunPeriod">-</p>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" id="btnViewPayRun" style="display:none;">
                        View Details
                    </button>
                </div>

                <div id="payRunTimeline" style="display:none;">
                    <hr>
                    <h5>Processing Timeline</h5>
                    <div id="timeline">
                        <div class="timeline-item complete">
                            <strong>Data Loaded</strong>
                            <small class="text-muted d-block">Deputy timesheets, Vend balances, Xero employees</small>
                        </div>
                        <div class="timeline-item complete">
                            <strong>Bonuses Calculated</strong>
                            <small class="text-muted d-block">Vape drops, reviews, gamification</small>
                        </div>
                        <div class="timeline-item pending">
                            <strong>AI Review</strong>
                            <small class="text-muted d-block">Automated validation & anomaly detection</small>
                        </div>
                        <div class="timeline-item">
                            <strong>Push to Xero</strong>
                            <small class="text-muted d-block">Awaiting approval</small>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-success" id="btnContinueProcessing">
                            <i class="fas fa-arrow-right"></i> Continue Processing
                        </button>
                        <button class="btn btn-primary" id="btnPushToXero">
                            <i class="fas fa-cloud-upload-alt"></i> Push to Xero
                        </button>
                        <button class="btn btn-warning" id="btnReviewPayslips">
                            <i class="fas fa-eye"></i> Review Payslips
                        </button>
                    </div>
                </div>

                <div id="noActivePayRun">
                    <hr>
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No active pay run. Start a new one to begin processing.</p>
                        <button class="btn btn-lg btn-primary" id="btnStartNew">
                            <i class="fas fa-play"></i> Start New Pay Run
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Payslips -->
            <div class="card">
                <div class="card-header">
                    <strong><i class="fas fa-file-invoice-dollar"></i> Recent Payslips</strong>
                    <span class="badge badge-secondary float-right" id="payslipCount">0</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="payslipsTable">
                            <thead>
                                <tr>
                                    <th>Staff</th>
                                    <th>Period</th>
                                    <th>Gross Pay</th>
                                    <th>Net Pay</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <!-- Right Column: Actions & Alerts -->
        <div class="col-md-4">

            <!-- AI Automation Status -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <strong><i class="fas fa-robot"></i> AI Automation</strong>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Auto-Approval Rate</span>
                            <strong id="autoApprovalRate">-%</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" id="autoApprovalProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Avg Processing Time</span>
                            <strong id="avgProcessingTime">-</strong>
                        </div>
                    </div>
                    <a href="/modules/human_resources/payroll/views/automation_dashboard.php" class="btn btn-sm btn-block btn-outline-primary">
                        <i class="fas fa-chart-line"></i> View Full AI Dashboard
                    </a>
                </div>
            </div>

            <!-- Pending Discrepancies -->
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                    <strong><i class="fas fa-exclamation-triangle"></i> Pending Discrepancies</strong>
                    <span class="badge badge-light float-right" id="discrepancyCount">0</span>
                </div>
                <div class="card-body p-0" id="discrepanciesList">
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <strong><i class="fas fa-bolt"></i> Quick Actions</strong>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action" id="btnSnapshotPayroll">
                        <i class="fas fa-camera"></i> Snapshot Current State
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" id="btnViewAmendments">
                        <i class="fas fa-edit"></i> View Amendments
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" id="btnExportBank">
                        <i class="fas fa-file-csv"></i> Export Bank File
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" id="btnAuditLog">
                        <i class="fas fa-history"></i> View Audit Log
                    </a>
                    <a href="/wage-discrepancies.php" class="list-group-item list-group-item-action">
                        <i class="fas fa-flag"></i> Report Pay Issue (Staff)
                    </a>
                </div>
            </div>

        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {

    // Load dashboard data
    function loadDashboard() {
        // Load stats
        $.get('/api/payroll/dashboard', function(data) {
            if (data.success) {
                $('#statActiveStaff').text(data.stats.active_staff || 0);
                $('#statPendingHours').text((data.stats.pending_hours || 0).toFixed(1) + 'h');
                $('#statDiscrepancies').text(data.stats.pending_discrepancies || 0);
                $('#statAutoApproved').text(data.stats.auto_approved_today || 0);
            }
        }).fail(function() {
            console.error('Failed to load dashboard stats');
        });

        // Load current pay run
        $.get('/api/payroll/current-run', function(data) {
            if (data.success && data.pay_run) {
                showPayRun(data.pay_run);
            } else {
                showNoActiveRun();
            }
        });

        // Load recent payslips
        $.get('/api/payroll/payslips/recent', function(data) {
            if (data.success) {
                renderPayslips(data.payslips);
            }
        });

        // Load discrepancies
        $.get('/api/payroll/discrepancies/pending', function(data) {
            if (data.success) {
                renderDiscrepancies(data.discrepancies);
            }
        });

        // Load AI stats
        $.get('/api/payroll/automation/dashboard', function(data) {
            if (data.success && data.stats) {
                const rate = data.stats.auto_approval_rate || 0;
                $('#autoApprovalRate').text(rate.toFixed(1) + '%');
                $('#autoApprovalProgress').css('width', rate + '%');
                $('#avgProcessingTime').text(data.stats.avg_processing_time || 'N/A');
            }
        });
    }

    function showPayRun(payRun) {
        $('#currentPayRunStatus').removeClass().addClass('status-badge status-' + payRun.status).text(payRun.status);
        $('#currentPayRunPeriod').text(payRun.period_start + ' to ' + payRun.period_end);
        $('#noActivePayRun').hide();
        $('#payRunTimeline').show();
        $('#btnViewPayRun').show();
    }

    function showNoActiveRun() {
        $('#noActivePayRun').show();
        $('#payRunTimeline').hide();
        $('#btnViewPayRun').hide();
    }

    function renderPayslips(payslips) {
        const tbody = $('#payslipsTable tbody');
        tbody.empty();

        if (!payslips || payslips.length === 0) {
            tbody.append('<tr><td colspan="6" class="text-center text-muted py-3">No payslips found</td></tr>');
            return;
        }

        $('#payslipCount').text(payslips.length);

        payslips.forEach(function(p) {
            const row = $('<tr>');
            row.append('<td>' + p.staff_name + '</td>');
            row.append('<td><small>' + p.period_start + '<br>to ' + p.period_end + '</small></td>');
            row.append('<td>$' + parseFloat(p.gross_pay).toFixed(2) + '</td>');
            row.append('<td>$' + parseFloat(p.net_pay).toFixed(2) + '</td>');
            row.append('<td><span class="status-badge status-' + p.status + '">' + p.status + '</span></td>');
            row.append('<td><button class="btn btn-sm btn-outline-primary view-payslip" data-id="' + p.id + '">View</button></td>');
            tbody.append(row);
        });
    }

    function renderDiscrepancies(discrepancies) {
        const container = $('#discrepanciesList');
        container.empty();
        $('#discrepancyCount').text(discrepancies ? discrepancies.length : 0);

        if (!discrepancies || discrepancies.length === 0) {
            container.html('<div class="text-center py-3 text-muted">No pending discrepancies</div>');
            return;
        }

        const list = $('<div class="list-group list-group-flush">');
        discrepancies.slice(0, 5).forEach(function(d) {
            const item = $('<a href="#" class="list-group-item list-group-item-action view-discrepancy" data-id="' + d.id + '">');
            item.append('<div class="d-flex w-100 justify-content-between">');
            item.append('<strong>' + d.staff_name + '</strong>');
            item.append('<small class="text-' + (d.priority === 'urgent' ? 'danger' : 'warning') + '">' + d.priority + '</small>');
            item.append('</div>');
            item.append('<small class="text-muted">' + d.discrepancy_type + ' - $' + parseFloat(d.claimed_amount || 0).toFixed(2) + '</small>');
            list.append(item);
        });
        container.append(list);

        if (discrepancies.length > 5) {
            container.append('<a href="/modules/human_resources/payroll/views/discrepancies.php" class="btn btn-sm btn-block btn-outline-warning mt-2">View All (' + discrepancies.length + ')</a>');
        }
    }

    // Event handlers
    $('#btnRefresh').click(function() {
        $(this).find('i').addClass('fa-spin');
        loadDashboard();
        setTimeout(() => $(this).find('i').removeClass('fa-spin'), 1000);
    });

    $('#btnNewPayRun, #btnStartNew').click(function() {
        if (confirm('Start a new pay run? This will load data from Deputy, Vend, and Xero.')) {
            $.post('/api/payroll/pay-runs/create', function(data) {
                if (data.success) {
                    alert('Pay run created successfully!');
                    loadDashboard();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            }).fail(function() {
                alert('Failed to create pay run. Check console for details.');
            });
        }
    });

    $('#btnSnapshotPayroll').click(function(e) {
        e.preventDefault();
        if (confirm('Create a snapshot of current payroll state?')) {
            $.post('/api/payroll/snapshot/create', function(data) {
                if (data.success) {
                    alert('Snapshot created: ' + data.snapshot_id);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            });
        }
    });

    $(document).on('click', '.view-payslip', function() {
        const id = $(this).data('id');
        window.location.href = '/modules/human_resources/payroll/views/payslip_detail.php?id=' + id;
    });

    $(document).on('click', '.view-discrepancy', function(e) {
        e.preventDefault();
        const id = $(this).data('id');
        window.location.href = '/modules/human_resources/payroll/views/discrepancy_detail.php?id=' + id;
    });

    // Initial load
    loadDashboard();

    // Auto-refresh every 30 seconds
    setInterval(loadDashboard, 30000);
});
</script>

</body>
</html>
